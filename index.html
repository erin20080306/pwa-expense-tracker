<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>記帳小幫手</title>
    <meta name="description" content="簡單好用的記帳 App">
    <meta name="theme-color" content="#C9B7FF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="記帳小幫手">
    <meta name="application-name" content="記帳小幫手">
    <meta name="msapplication-TileColor" content="#C9B7FF">
    <meta name="msapplication-config" content="/browserconfig.xml">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" sizes="192x192" href="assets/icon-192.svg">
    <link rel="apple-touch-icon" sizes="512x512" href="assets/icon-512.svg">
    <link rel="icon" type="image/svg+xml" sizes="32x32" href="assets/icon-192.svg">
    <link rel="icon" type="image/svg+xml" sizes="16x16" href="assets/icon-192.svg">
    
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="screen">
        <div class="welcome-card">
            <div class="welcome-illustration">
                <svg width="200" height="200" viewBox="0 0 200 200" fill="none">
                    <rect x="40" y="60" width="120" height="80" rx="12" fill="#8B5CF6"/>
                    <circle cx="70" cy="90" r="8" fill="#FCD34D"/>
                    <circle cx="100" cy="85" r="6" fill="#FCD34D"/>
                    <circle cx="130" cy="95" r="7" fill="#FCD34D"/>
                    <circle cx="85" cy="110" r="5" fill="#FCD34D"/>
                    <circle cx="115" cy="105" r="6" fill="#FCD34D"/>
                    <circle cx="150" cy="120" r="4" fill="#FCD34D"/>
                    <circle cx="55" cy="125" r="5" fill="#FCD34D"/>
                </svg>
            </div>
            <h1 class="welcome-title">用記帳小幫手管理你的財務</h1>
            <p class="welcome-description">輕鬆記錄每筆收支，讓你的錢為你工作，實現財務自由！</p>
            <button class="welcome-button" onclick="startApp()">開始使用</button>
        </div>
    </div>

    <!-- PIN Lock Screen -->
    <div id="pinScreen" class="screen" style="display: none;">
        <div class="pin-card">
            <h2 class="pin-title">請輸入密碼</h2>
            <div class="pin-input-container">
                <input type="password" id="pinInput" maxlength="6" pattern="[0-9]*" inputmode="numeric">
            </div>
            <div class="pin-keypad">
                <button onclick="addPinDigit('1')">1</button>
                <button onclick="addPinDigit('2')">2</button>
                <button onclick="addPinDigit('3')">3</button>
                <button onclick="addPinDigit('4')">4</button>
                <button onclick="addPinDigit('5')">5</button>
                <button onclick="addPinDigit('6')">6</button>
                <button onclick="addPinDigit('7')">7</button>
                <button onclick="addPinDigit('8')">8</button>
                <button onclick="addPinDigit('9')">9</button>
                <button onclick="clearPin()">清除</button>
                <button onclick="addPinDigit('0')">0</button>
                <button onclick="deletePinDigit()">⌫</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="app-container" style="display: none;">
        <!-- Home Screen -->
        <div id="homeScreen" class="screen active">
            <div class="top-nav">
                <button class="nav-button">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="5" r="2" fill="#333"/>
                        <circle cx="12" cy="12" r="2" fill="#333"/>
                        <circle cx="12" cy="19" r="2" fill="#333"/>
                    </svg>
                </button>
                <button class="nav-button">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="#333" stroke-width="2"/>
                        <path d="M12 8V12L15 15" stroke="#333" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>

            <div class="gradient-card">
                <div class="balance-header">
                    <span>總餘額</span>
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M4 6L8 10L12 6" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </div>
                <div class="balance-amount" id="totalBalance">$3,257.00</div>
                <div class="balance-details">
                    <div class="balance-item">
                        <div class="balance-item-header">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <path d="M8 2L12 6" stroke="#8B5CF6" stroke-width="2" stroke-linecap="round"/>
                                <path d="M4 10L8 14L12 10" stroke="#8B5CF6" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            <span>收入</span>
                        </div>
                        <span class="income-amount" id="totalIncome">$2,350.00</span>
                    </div>
                    <div class="balance-item">
                        <div class="balance-item-header">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <path d="M8 14L4 10" stroke="#EC4899" stroke-width="2" stroke-linecap="round"/>
                                <path d="M12 6L8 2L4 6" stroke="#EC4899" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            <span>支出</span>
                        </div>
                        <span class="expense-amount" id="totalExpenses">$950.00</span>
                    </div>
                </div>
            </div>

            <!-- Budget Progress -->
            <div class="budget-progress-card" id="budgetProgressCard" style="display: none;">
                <div class="budget-header">
                    <span>本月預算</span>
                    <span class="budget-remaining" id="budgetRemaining">剩餘 $1,050</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="budgetProgressFill"></div>
                </div>
                <div class="budget-details">
                    <span id="budgetSpent">已花費 $950</span>
                    <span id="budgetTotal">預算 $2,000</span>
                </div>
            </div>

            <div class="transactions-section">
                <div class="section-header">
                    <h3>交易紀錄</h3>
                    <button class="see-all-btn">查看全部</button>
                </div>
                <div class="transactions-list" id="transactionsList">
                    <!-- Transactions will be populated here -->
                </div>
            </div>
        </div>

        <!-- Overview Screen -->
        <div id="overviewScreen" class="screen">
            <div class="top-nav">
                <button class="nav-button">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="5" r="2" fill="#333"/>
                        <circle cx="12" cy="12" r="2" fill="#333"/>
                        <circle cx="12" cy="19" r="2" fill="#333"/>
                    </svg>
                </button>
                <h2 class="nav-title">總覽</h2>
            </div>

            <div class="overview-cards">
                <div class="overview-card">
                    <div class="card-icon income-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M12 2L16 6" stroke="#8B5CF6" stroke-width="2" stroke-linecap="round"/>
                            <path d="M8 10L12 14L16 10" stroke="#8B5CF6" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <div class="card-content">
                        <span class="card-label">總收入</span>
                        <span class="card-amount" id="overviewIncome">$8,500</span>
                    </div>
                </div>
                <div class="overview-card">
                    <div class="card-icon expense-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M12 22L8 18" stroke="#F97316" stroke-width="2" stroke-linecap="round"/>
                            <path d="M16 14L12 10L8 14" stroke="#F97316" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <div class="card-content">
                        <span class="card-label">總支出</span>
                        <span class="card-amount" id="overviewExpenses">$3,800</span>
                    </div>
                </div>
            </div>

            <div class="statistics-section">
                <div class="section-header">
                    <h3>統計</h3>
                    <div class="date-range">
                        <span id="dateRange">Apr 01 - Apr 30</span>
                        <select id="periodSelect">
                            <option value="monthly">每月</option>
                            <option value="weekly">每週</option>
                            <option value="yearly">每年</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="statisticsChart"></canvas>
                </div>
            </div>

            <div class="toggle-section">
                <div class="toggle-buttons">
                    <button class="toggle-btn active" data-type="income">收入</button>
                    <button class="toggle-btn" data-type="expense">支出</button>
                </div>
                <div class="categories-list" id="categoriesList">
                    <!-- Categories will be populated here -->
                </div>
            </div>
        </div>

        <!-- Calendar Screen -->
        <div id="calendarScreen" class="screen">
            <div class="top-nav">
                <button class="nav-button">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="5" r="2" fill="#333"/>
                        <circle cx="12" cy="12" r="2" fill="#333"/>
                        <circle cx="12" cy="19" r="2" fill="#333"/>
                    </svg>
                </button>
                <h2 class="nav-title">日曆</h2>
            </div>

            <div class="calendar-header">
                <button class="calendar-nav" onclick="previousMonth()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M15 18L9 12L15 6" stroke="#333" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
                <h3 id="currentMonth">April 2024</h3>
                <button class="calendar-nav" onclick="nextMonth()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M9 6L15 12L9 18" stroke="#333" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>

            <div class="calendar-grid">
                <div class="calendar-weekdays">
                    <span>日</span>
                    <span>一</span>
                    <span>二</span>
                    <span>三</span>
                    <span>四</span>
                    <span>五</span>
                    <span>六</span>
                </div>
                <div class="calendar-days" id="calendarDays">
                    <!-- Calendar days will be populated here -->
                </div>
            </div>
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" class="screen">
            <div class="top-nav">
                <button class="nav-button">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="5" r="2" fill="#333"/>
                        <circle cx="12" cy="12" r="2" fill="#333"/>
                        <circle cx="12" cy="19" r="2" fill="#333"/>
                    </svg>
                </button>
                <h2 class="nav-title">設定</h2>
            </div>

            <div class="settings-sections">
                <div class="settings-section">
                    <h3>預算與目標</h3>
                    <div class="setting-item">
                        <span>每月預算</span>
                        <input type="number" id="monthlyBudgetInput" placeholder="2000">
                    </div>
                    <div class="setting-item">
                        <span>儲蓄目標</span>
                        <input type="number" id="savingsGoalInput" placeholder="1000">
                    </div>
                </div>

                <div class="settings-section">
                    <h3>安全性</h3>
                    <div class="setting-item">
                        <span>密碼鎖</span>
                        <label class="switch">
                            <input type="checkbox" id="pinLockToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span>變更密碼</span>
                        <button class="setting-btn" onclick="showChangePinDialog()">變更</button>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>通知</h3>
                    <div class="setting-item">
                        <span>每日記帳提醒</span>
                        <label class="switch">
                            <input type="checkbox" id="dailyReminderToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>雲端同步</h3>
                    <div class="setting-item">
                        <span>啟用同步</span>
                        <label class="switch">
                            <input type="checkbox" id="cloudSyncToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span>Supabase URL</span>
                        <input type="text" id="supabaseUrlInput" placeholder="https://your-project.supabase.co">
                    </div>
                    <div class="setting-item">
                        <span>Supabase Key</span>
                        <input type="password" id="supabaseKeyInput" placeholder="your-anon-key">
                    </div>
                </div>

                <div class="settings-section">
                    <h3>分類管理</h3>
                    <button class="setting-btn" onclick="showCategoriesDialog()">管理分類</button>
                </div>

                <div class="settings-section">
                    <h3>資料</h3>
                    <button class="setting-btn" onclick="exportData()">匯出資料</button>
                    <button class="setting-btn" onclick="importData()">匯入資料</button>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="nav-item active" data-screen="home">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="#8B5CF6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9 22V12H15V22" stroke="#8B5CF6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>首頁</span>
            </button>
            
            <button class="nav-item" data-screen="overview">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <rect x="3" y="3" width="7" height="7" stroke="#666" stroke-width="2"/>
                    <rect x="14" y="3" width="7" height="7" stroke="#666" stroke-width="2"/>
                    <rect x="14" y="14" width="7" height="7" stroke="#666" stroke-width="2"/>
                    <rect x="3" y="14" width="7" height="7" stroke="#666" stroke-width="2"/>
                </svg>
                <span>總覽</span>
            </button>
            
            <!-- FAB Button -->
            <button class="fab-button" onclick="openAddTransaction()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M12 5V19M5 12H19" stroke="white" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            
            <button class="nav-item" data-screen="calendar">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <rect x="3" y="4" width="18" height="18" rx="2" stroke="#666" stroke-width="2"/>
                    <path d="M16 2V6M8 2V6M3 10H21" stroke="#666" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span>日曆</span>
            </button>
            
            <button class="nav-item" data-screen="settings">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="3" stroke="#666" stroke-width="2"/>
                    <path d="M12 1V6M12 18V23M4.22 4.22L7.76 7.76M16.24 16.24L19.78 19.78M1 12H6M18 12H23M4.22 19.78L7.76 16.24M16.24 7.76L19.78 4.22" stroke="#666" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span>設定</span>
            </button>
        </div>
    </div>

    <!-- Add Transaction Bottom Sheet -->
    <div id="addTransactionSheet" class="bottom-sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-content">
            <h3 id="transactionSheetTitle">新增交易</h3>
            <input type="hidden" id="editTransactionId" value="">
            
            <div class="toggle-buttons">
                <button class="toggle-btn active" data-type="income">收入</button>
                <button class="toggle-btn" data-type="expense">支出</button>
            </div>

            <div class="form-group">
                <label>金額</label>
                <input type="number" id="transactionAmount" placeholder="0.00" step="0.01">
            </div>

            <div class="form-group">
                <label>分類</label>
                <select id="transactionCategory">
                    <!-- Categories will be populated here -->
                </select>
            </div>

            <div class="form-group">
                <label>備註</label>
                <input type="text" id="transactionNote" placeholder="選填備註">
            </div>

            <div class="form-group">
                <label>日期</label>
                <input type="date" id="transactionDate">
            </div>

            <div class="form-group scan-buttons">
                <button class="scan-receipt-btn" onclick="scanReceipt()">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <path d="M3 7V4C3 3.44772 3.44772 3 4 3H7M17 7V4C17 3.44772 16.5523 3 16 3H13M13 17H16C16.5523 17 17 16.5523 17 16V13M7 17H4C3.44772 17 3 16.5523 3 16V13" stroke="#8B5CF6" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    掃描收據
                </button>
                <button class="scan-receipt-btn" onclick="openQRScanner()">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <rect x="3" y="3" width="6" height="6" rx="1" stroke="#8B5CF6" stroke-width="2"/>
                        <rect x="11" y="3" width="6" height="6" rx="1" stroke="#8B5CF6" stroke-width="2"/>
                        <rect x="3" y="11" width="6" height="6" rx="1" stroke="#8B5CF6" stroke-width="2"/>
                        <rect x="12" y="12" width="4" height="4" fill="#8B5CF6"/>
                    </svg>
                    掃描 QR/條碼
                </button>
            </div>

            <div class="sheet-actions">
                <button class="cancel-btn" onclick="closeAddTransaction()">取消</button>
                <button class="delete-btn" id="deleteTransactionBtn" onclick="deleteTransaction()" style="display: none; background: #EF4444;">刪除</button>
                <button class="save-btn" onclick="saveTransaction()">儲存</button>
            </div>
        </div>
    </div>

    <!-- Categories Management Modal -->
    <div id="categoriesModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>管理分類</h3>
                <button class="close-btn" onclick="closeCategoriesDialog()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="categories-tabs">
                    <button class="tab-btn active" data-tab="income">收入</button>
                    <button class="tab-btn" data-tab="expense">支出</button>
                </div>
                <div class="categories-management">
                    <div class="add-category">
                        <div class="icon-picker-container">
                            <button type="button" id="selectedIconBtn" class="icon-picker-btn" onclick="toggleIconPicker()">😀</button>
                            <div id="iconPicker" class="icon-picker" style="display: none;">
                                <span onclick="selectIcon('🍜')">🍜</span>
                                <span onclick="selectIcon('🧋')">🧋</span>
                                <span onclick="selectIcon('🍔')">🍔</span>
                                <span onclick="selectIcon('☕')">☕</span>
                                <span onclick="selectIcon('🚌')">🚌</span>
                                <span onclick="selectIcon('🚗')">🚗</span>
                                <span onclick="selectIcon('✈️')">✈️</span>
                                <span onclick="selectIcon('🛒')">🛒</span>
                                <span onclick="selectIcon('👕')">👕</span>
                                <span onclick="selectIcon('👟')">👟</span>
                                <span onclick="selectIcon('🎬')">🎬</span>
                                <span onclick="selectIcon('🎮')">🎮</span>
                                <span onclick="selectIcon('🎵')">🎵</span>
                                <span onclick="selectIcon('📖')">📖</span>
                                <span onclick="selectIcon('💊')">💊</span>
                                <span onclick="selectIcon('🏥')">🏥</span>
                                <span onclick="selectIcon('🐱')">🐱</span>
                                <span onclick="selectIcon('🐶')">🐶</span>
                                <span onclick="selectIcon('💄')">💄</span>
                                <span onclick="selectIcon('🏃')">🏃</span>
                                <span onclick="selectIcon('📱')">📱</span>
                                <span onclick="selectIcon('💡')">💡</span>
                                <span onclick="selectIcon('🏠')">🏠</span>
                                <span onclick="selectIcon('🧴')">🧴</span>
                                <span onclick="selectIcon('🤑')">🤑</span>
                                <span onclick="selectIcon('💪')">💪</span>
                                <span onclick="selectIcon('🎉')">🎉</span>
                                <span onclick="selectIcon('🌱')">🌱</span>
                                <span onclick="selectIcon('🧧')">🧧</span>
                                <span onclick="selectIcon('✨')">✨</span>
                                <span onclick="selectIcon('💰')">💰</span>
                                <span onclick="selectIcon('🎁')">🎁</span>
                            </div>
                        </div>
                        <input type="text" id="newCategoryName" placeholder="新分類名稱">
                        <button onclick="addCategory()">新增</button>
                    </div>
                    <div class="categories-list-management" id="categoriesListManagement">
                        <!-- Categories will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Change PIN Modal -->
    <div id="changePinModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>變更密碼</h3>
                <button class="close-btn" onclick="closeChangePinDialog()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>目前密碼</label>
                    <input type="password" id="currentPin" maxlength="6" pattern="[0-9]*" inputmode="numeric">
                </div>
                <div class="form-group">
                    <label>新密碼</label>
                    <input type="password" id="newPin" maxlength="6" pattern="[0-9]*" inputmode="numeric">
                </div>
                <div class="form-group">
                    <label>確認新密碼</label>
                    <input type="password" id="confirmNewPin" maxlength="6" pattern="[0-9]*" inputmode="numeric">
                </div>
                <div class="modal-actions">
                    <button class="cancel-btn" onclick="closeChangePinDialog()">取消</button>
                    <button class="save-btn" onclick="changePin()">變更密碼</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input for receipt scanning -->
    <input type="file" id="receiptFileInput" accept="image/*" style="display: none;" onchange="handleReceiptFile(event)">

    <!-- QR/Barcode Scanner Modal -->
    <div id="qrScannerModal" class="modal" style="display: none;">
        <div class="modal-content qr-scanner-content">
            <div class="modal-header">
                <h3>掃描 QR 碼 / 條碼</h3>
                <button class="close-btn" onclick="closeQRScanner()">&times;</button>
            </div>
            <div class="scanner-container">
                <video id="qrVideo" autoplay playsinline></video>
                <canvas id="qrCanvas" style="display: none;"></canvas>
                <div class="scanner-overlay">
                    <div class="scanner-frame"></div>
                </div>
            </div>
            <div id="qrResult" class="qr-result" style="display: none;">
                <p>掃描結果：</p>
                <p id="qrResultText"></p>
            </div>
            <p class="scanner-hint">將 QR 碼或條碼對準框內</p>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeQRScanner()">關閉</button>
            </div>
        </div>
    </div>

    <script src="db.js"></script>
    <script src="app.js"></script>
    <script src="ui-home.js"></script>
    <script src="ui-overview.js"></script>
    <script src="ui-calendar.js"></script>
</body>
</html>
